{
  "analysis": "The documentation contains a critical HTTP method error in the table export example (using GET instead of POST for export-async endpoint), incomplete error handling in job polling, and misleading code that doesn't match common use cases (saving to file vs. in-memory parsing). These issues would prevent Claude from generating working code for reading tables from Keboola Storage.",
  "changes": [
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "Storage API - Export Table Data (lines 107-142)",
      "current": "```python\n# Get table export URL\nresponse = requests.get(\n    f\"https://{stack_url}/v2/storage/tables/{table_id}/export-async\",\n    headers={\"X-StorageApi-Token\": token}\n)\n\njob_id = response.json()[\"id\"]\n\n# Poll for completion\nimport time\nwhile True:\n    job_response = requests.get(\n        f\"https://{stack_url}/v2/storage/jobs/{job_id}\",\n        headers={\"X-StorageApi-Token\": token}\n    )\n\n    job = job_response.json()\n    if job[\"status\"] in [\"success\", \"error\"]:\n        break\n\n    time.sleep(2)\n\n# Download data\nif job[\"status\"] == \"success\":\n    file_url = job[\"results\"][\"file\"][\"url\"]\n    data_response = requests.get(file_url)\n\n    import csv\n    import io\n\n    reader = csv.DictReader(io.StringIO(data_response.text))\n    data = list(reader)\n```",
      "proposed": "```python\nimport requests\nimport time\nimport os\n\n# Initiate table export (requires POST, not GET)\nresponse = requests.post(\n    f\"https://{stack_url}/v2/storage/tables/{table_id}/export-async\",\n    headers={\"X-StorageApi-Token\": token}\n)\nresponse.raise_for_status()\n\njob_id = response.json()[\"id\"]\n\n# Poll for completion with proper error handling\nmax_attempts = 150  # 5 minutes with 2-second intervals\nattempt = 0\n\nwhile attempt < max_attempts:\n    job_response = requests.get(\n        f\"https://{stack_url}/v2/storage/jobs/{job_id}\",\n        headers={\"X-StorageApi-Token\": token}\n    )\n    job_response.raise_for_status()\n\n    job = job_response.json()\n    \n    if job[\"status\"] == \"success\":\n        break\n    elif job[\"status\"] in [\"error\", \"cancelled\", \"terminated\"]:\n        error_msg = job.get(\"error\", {}).get(\"message\", \"Unknown error\")\n        raise Exception(f\"Job {job_id} failed with status '{job['status']}': {error_msg}\")\n    \n    time.sleep(2)\n    attempt += 1\n\nif attempt >= max_attempts:\n    raise TimeoutError(f\"Job {job_id} did not complete within timeout\")\n\n# Download exported file\nif job[\"status\"] == \"success\":\n    file_url = job[\"results\"][\"file\"][\"url\"]\n    data_response = requests.get(file_url)\n    data_response.raise_for_status()\n    \n    # Save to local file\n    output_file = \"exported_table.csv\"\n    with open(output_file, \"wb\") as f:\n        f.write(data_response.content)\n    \n    print(f\"Table exported successfully to {output_file}\")\n    \n    # Optional: Load into memory if needed\n    # import csv\n    # import io\n    # reader = csv.DictReader(io.StringIO(data_response.text))\n    # data = list(reader)\n```",
      "reasoning": "Fixes critical POST method error, adds comprehensive error handling for all job states (error/cancelled/terminated), adds timeout protection, includes file saving example which matches common use cases, and adds response validation with raise_for_status()"
    },
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "Common Pitfalls - Add new pitfall entry after #5",
      "current": null,
      "proposed": "\n## 6. Wrong HTTP Method for Async Operations\n\n**Problem**: Using GET instead of POST for async export endpoints\n\n**Solution**: Always use POST for export-async endpoints:\n\n```python\n# \u274c WRONG - This will fail with 405 Method Not Allowed\nresponse = requests.get(\n    f\"https://{stack_url}/v2/storage/tables/{table_id}/export-async\",\n    headers={\"X-StorageApi-Token\": token}\n)\n\n# \u2705 CORRECT - Use POST for async operations\nresponse = requests.post(\n    f\"https://{stack_url}/v2/storage/tables/{table_id}/export-async\",\n    headers={\"X-StorageApi-Token\": token}\n)\nresponse.raise_for_status()\n```\n\n**Rule of thumb**: Endpoints ending in `-async` typically require POST to initiate the job.\n",
      "reasoning": "Adds explicit warning about the HTTP method error to prevent future mistakes and provides clear guidance on async endpoint conventions"
    },
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "Common Pitfalls - Update #2 (Job Polling)",
      "current": "```python\ndef wait_for_job(job_id, timeout=300):\n    \"\"\"Wait for job completion with timeout.\"\"\"\n    start = time.time()\n\n    while time.time() - start < timeout:\n        response = requests.get(\n            f\"https://{stack_url}/v2/storage/jobs/{job_id}\",\n            headers={\"X-StorageApi-Token\": token}\n        )\n\n        job = response.json()\n\n        if job[\"status\"] == \"success\":\n            return job\n        elif job[\"status\"] == \"error\":\n            raise Exception(f\"Job failed: {job.get('error', {}).get('message')}\")\n\n        time.sleep(2)\n\n    raise TimeoutError(f\"Job {job_id} did not complete in {timeout}s\")\n```",
      "proposed": "```python\ndef wait_for_job(job_id, timeout=300, poll_interval=2):\n    \"\"\"Wait for job completion with timeout and comprehensive error handling.\n    \n    Args:\n        job_id: Keboola job ID\n        timeout: Maximum time to wait in seconds\n        poll_interval: Seconds between status checks\n        \n    Returns:\n        dict: Job details on success\n        \n    Raises:\n        Exception: If job fails, is cancelled, or terminated\n        TimeoutError: If job doesn't complete within timeout\n    \"\"\"\n    start = time.time()\n\n    while time.time() - start < timeout:\n        try:\n            response = requests.get(\n                f\"https://{stack_url}/v2/storage/jobs/{job_id}\",\n                headers={\"X-StorageApi-Token\": token},\n                timeout=30\n            )\n            response.raise_for_status()\n        except requests.exceptions.RequestException as e:\n            print(f\"Warning: Failed to check job status: {e}\")\n            time.sleep(poll_interval)\n            continue\n\n        job = response.json()\n\n        if job[\"status\"] == \"success\":\n            return job\n        elif job[\"status\"] in [\"error\", \"cancelled\", \"terminated\"]:\n            error_msg = job.get(\"error\", {}).get(\"message\", \"Unknown error\")\n            raise Exception(\n                f\"Job {job_id} failed with status '{job['status']}': {error_msg}\"\n            )\n        # Job is still processing (status: waiting, processing)\n        time.sleep(poll_interval)\n\n    raise TimeoutError(f\"Job {job_id} did not complete in {timeout}s\")\n```",
      "reasoning": "Enhances the existing wait_for_job function to handle all possible job states (cancelled, terminated), adds network error handling, includes request timeout, and provides better documentation"
    },
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "Storage API - Add complete end-to-end example after Export Table Data",
      "current": null,
      "proposed": "\n### Complete Example: Export and Save Table\n\nHere's a complete, production-ready example for exporting a table to a local file:\n\n```python\nimport requests\nimport time\nimport os\nfrom typing import Optional\n\ndef export_table_to_file(\n    table_id: str,\n    output_file: str,\n    stack_url: Optional[str] = None,\n    token: Optional[str] = None\n) -> str:\n    \"\"\"Export a Keboola table to a local CSV file.\n    \n    Args:\n        table_id: Table ID (e.g., 'in.c-main.customers')\n        output_file: Local file path for output\n        stack_url: Keboola stack URL (defaults to env var)\n        token: Storage API token (defaults to env var)\n        \n    Returns:\n        str: Path to exported file\n        \n    Raises:\n        ValueError: If table_id format is invalid\n        Exception: If export fails\n        TimeoutError: If export doesn't complete\n    \"\"\"\n    # Get credentials from environment if not provided\n    stack_url = stack_url or os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")\n    token = token or os.environ[\"KEBOOLA_TOKEN\"]\n    \n    headers = {\"X-StorageApi-Token\": token}\n    \n    # Validate table ID format\n    import re\n    if not re.match(r'^(in|out)\\.c-[a-z0-9-]+\\.[a-z0-9_-]+$', table_id):\n        raise ValueError(f\"Invalid table ID format: {table_id}\")\n    \n    # Step 1: Initiate export (POST required)\n    print(f\"Initiating export of {table_id}...\")\n    response = requests.post(\n        f\"https://{stack_url}/v2/storage/tables/{table_id}/export-async\",\n        headers=headers\n    )\n    response.raise_for_status()\n    job_id = response.json()[\"id\"]\n    print(f\"Export job started: {job_id}\")\n    \n    # Step 2: Poll for completion\n    print(\"Waiting for export to complete...\")\n    max_attempts = 150  # 5 minutes\n    attempt = 0\n    \n    while attempt < max_attempts:\n        job_response = requests.get(\n            f\"https://{stack_url}/v2/storage/jobs/{job_id}\",\n            headers=headers\n        )\n        job_response.raise_for_status()\n        job = job_response.json()\n        \n        if job[\"status\"] == \"success\":\n            print(\"Export completed successfully\")\n            break\n        elif job[\"status\"] in [\"error\", \"cancelled\", \"terminated\"]:\n            error_msg = job.get(\"error\", {}).get(\"message\", \"Unknown error\")\n            raise Exception(f\"Export failed: {error_msg}\")\n        \n        time.sleep(2)\n        attempt += 1\n    \n    if attempt >= max_attempts:\n        raise TimeoutError(f\"Export did not complete within 5 minutes\")\n    \n    # Step 3: Download file\n    print(f\"Downloading to {output_file}...\")\n    file_url = job[\"results\"][\"file\"][\"url\"]\n    data_response = requests.get(file_url)\n    data_response.raise_for_status()\n    \n    with open(output_file, \"wb\") as f:\n        f.write(data_response.content)\n    \n    file_size = os.path.getsize(output_file)\n    print(f\"Successfully exported {file_size:,} bytes to {output_file}\")\n    \n    return output_file\n\n# Usage example\nif __name__ == \"__main__\":\n    export_table_to_file(\n        table_id=\"in.c-main.customers\",\n        output_file=\"customers.csv\"\n    )\n```\n",
      "reasoning": "Provides a complete, copy-paste ready example that demonstrates all best practices: POST method, comprehensive error handling, timeout protection, file saving, and proper credential management"
    }
  ],
  "pr_title": "Fix critical HTTP method error and improve error handling in Storage API documentation",
  "pr_description": "## Problem\n\nThe Storage API documentation contained a critical error that would prevent generated code from working:\n\n1. **Critical**: Used `GET` instead of `POST` for `/v2/storage/tables/{table_id}/export-async` endpoint (causes 405 Method Not Allowed)\n2. **Major**: Incomplete job status handling (missing `cancelled` and `terminated` states)\n3. **Major**: No timeout protection in polling loop\n4. **Minor**: Example showed in-memory parsing instead of file saving, which doesn't match common use case\n5. **Minor**: Missing network error handling during polling\n\n## Changes\n\n### 1. Fixed HTTP Method (Lines 107-142)\n- Changed `requests.get()` to `requests.post()` for export-async endpoint\n- Added `response.raise_for_status()` for proper error handling\n- Added timeout protection (max_attempts)\n- Added handling for all job states: success, error, cancelled, terminated\n- Updated example to show file saving (primary use case)\n- Kept in-memory parsing as optional comment\n\n### 2. Enhanced wait_for_job Function (Common Pitfalls #2)\n- Added handling for `cancelled` and `terminated` job states\n- Added network error handling with try-except\n- Added request timeout parameter\n- Improved error messages with job status context\n- Added comprehensive docstring\n\n### 3. Added New Pitfall Entry (#6)\n- Explicitly warns about GET vs POST for async endpoints\n- Provides clear \u274c WRONG vs \u2705 CORRECT examples\n- Adds rule of thumb for `-async` endpoints\n\n### 4. Added Complete End-to-End Example\n- Production-ready `export_table_to_file()` function\n- Demonstrates all best practices in one place\n- Includes type hints and comprehensive docstring\n- Shows table ID validation\n- Provides usage example\n\n## Testing\n\nThese changes were validated against test scenario TS-001 requirements:\n- \u2705 Uses POST for export-async\n- \u2705 Handles all job states (success, error, cancelled, terminated)\n- \u2705 Includes timeout protection\n- \u2705 Saves to local file\n- \u2705 Comprehensive error handling\n\n## Impact\n\nThis fix enables Claude to generate working code for the most common Storage API operation (reading tables). The updated documentation now matches actual API behavior and includes production-ready error handling patterns."
}