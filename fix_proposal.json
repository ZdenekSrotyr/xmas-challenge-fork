{
  "analysis": "The SKILL.md file in keboola-core is missing critical information about Custom Python Components. While it covers Storage API usage excellently, it doesn't address how to build and deploy custom Python components using the keboola.component library, component structure, manifest files, or Dockerfiles. This creates a significant gap for users trying to create custom transformations. The component-developer documentation exists but isn't referenced from keboola-core. We need to add a new section to SKILL.md covering custom Python components and cross-reference the component-developer documentation.",
  "changes": [
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "After line 216 (after Common Pitfalls section, before Metadata)",
      "current": "## Metadata",
      "proposed": "---\n\n<!-- Source: 04-custom-python-components.md -->\n\n# Custom Python Components\n\n## Overview\n\nFor complex transformations and custom logic, you can build Custom Python Components using the `keboola.component` library. These components run as Docker containers in Keboola and can read from Storage, process data, and write back results.\n\n**When to use Custom Python Components:**\n- Complex data transformations requiring custom Python libraries\n- Need for state management (incremental loads)\n- Integration with external APIs requiring custom logic\n- Reusable transformation logic across multiple projects\n\n**For comprehensive component development, see:** `claude/component-developer/`\n\n## Component Structure\n\n### Basic Directory Structure\n\n```\nmy-component/\n\u251c\u2500\u2500 src/\n\u2502   \u2514\u2500\u2500 component.py          # Main component logic\n\u251c\u2500\u2500 tests/\n\u2502   \u2514\u2500\u2500 test_component.py\n\u251c\u2500\u2500 data/                      # Local testing data\n\u2502   \u251c\u2500\u2500 in/\n\u2502   \u2502   \u2514\u2500\u2500 tables/\n\u2502   \u2502       \u2514\u2500\u2500 source.csv\n\u2502   \u251c\u2500\u2500 out/\n\u2502   \u2502   \u2514\u2500\u2500 tables/\n\u2502   \u2514\u2500\u2500 config.json\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 requirements.txt\n\u2514\u2500\u2500 component_config/\n    \u2514\u2500\u2500 component.json         # Configuration schema\n```\n\n### Component Code Example\n\n```python\nimport csv\nfrom keboola.component.base import ComponentBase\nfrom keboola.component.exceptions import UserException\n\nclass Component(ComponentBase):\n    def __init__(self):\n        super().__init__()\n\n    def run(self):\n        # Get parameters from config\n        params = self.configuration.parameters\n        multiplier = params.get('multiplier', 1)\n\n        # Get input table\n        input_tables = self.get_input_tables_definitions()\n        if not input_tables:\n            raise UserException(\"No input tables found\")\n\n        input_table = input_tables[0]\n\n        # Process data\n        output_data = []\n        with open(input_table.full_path, 'r') as input_file:\n            reader = csv.DictReader(input_file)\n            for row in reader:\n                # Transform data\n                row['value'] = int(row['value']) * multiplier\n                output_data.append(row)\n\n        # Write output\n        output_table_path = self.create_out_table_definition(\n            'result.csv',\n            incremental=False,\n            primary_key=['id']\n        )\n\n        with open(output_table_path.full_path, 'w', newline='') as output_file:\n            if output_data:\n                writer = csv.DictWriter(output_file, fieldnames=output_data[0].keys())\n                writer.writeheader()\n                writer.writerows(output_data)\n\nif __name__ == \"__main__\":\n    try:\n        comp = Component()\n        comp.run()\n    except UserException as exc:\n        comp.logger.error(exc)\n        exit(1)\n    except Exception as exc:\n        comp.logger.exception(exc)\n        exit(2)\n```\n\n## Input/Output Mapping\n\n### Configuration Format\n\n```json\n{\n  \"parameters\": {\n    \"multiplier\": 2\n  },\n  \"storage\": {\n    \"input\": {\n      \"tables\": [\n        {\n          \"source\": \"in.c-main.source-table\",\n          \"destination\": \"source.csv\"\n        }\n      ]\n    },\n    \"output\": {\n      \"tables\": [\n        {\n          \"source\": \"result.csv\",\n          \"destination\": \"out.c-main.result-table\",\n          \"incremental\": false,\n          \"primary_key\": [\"id\"]\n        }\n      ]\n    }\n  }\n}\n```\n\n### Accessing Input Tables\n\n```python\n# Get all input tables\ninput_tables = self.get_input_tables_definitions()\n\n# Access specific table\nfor table in input_tables:\n    print(f\"Table: {table.name}\")\n    print(f\"Path: {table.full_path}\")\n    print(f\"Columns: {table.columns}\")\n```\n\n### Creating Output Tables\n\n```python\n# Create output table with manifest\noutput_table = self.create_out_table_definition(\n    'output.csv',\n    incremental=False,\n    primary_key=['id'],\n    columns=['id', 'name', 'value']\n)\n\n# Write data\nwith open(output_table.full_path, 'w') as f:\n    writer = csv.writer(f)\n    writer.writerow(['id', 'name', 'value'])\n    writer.writerow([1, 'foo', 100])\n```\n\n## Manifest Files\n\nManifest files describe table metadata. They are automatically created when using `create_out_table_definition()`:\n\n```json\n{\n  \"destination\": \"out.c-main.result\",\n  \"incremental\": false,\n  \"primary_key\": [\"id\"],\n  \"columns\": [\"id\", \"name\", \"value\"],\n  \"delimiter\": \",\",\n  \"enclosure\": \"\\\"\"\n}\n```\n\n## Dockerfile\n\n```dockerfile\nFROM python:3.11-slim\n\nWORKDIR /code\n\n# Install dependencies\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n# Copy component code\nCOPY src/ /code/src/\n\n# Run component\nCMD [\"python\", \"-u\", \"/code/src/component.py\"]\n```\n\n## Local Testing\n\n### Setup Test Data\n\n```bash\n# Create directory structure\nmkdir -p data/in/tables data/out/tables\n\n# Add test CSV\necho \"id,name,value\" > data/in/tables/source.csv\necho \"1,foo,100\" >> data/in/tables/source.csv\necho \"2,bar,200\" >> data/in/tables/source.csv\n\n# Create config\ncat > data/config.json << EOF\n{\n  \"parameters\": {\n    \"multiplier\": 2\n  }\n}\nEOF\n```\n\n### Run Locally\n\n```bash\n# Set environment variables\nexport KBC_DATADIR=\"./data\"\n\n# Run component\npython src/component.py\n\n# Check output\ncat data/out/tables/result.csv\n```\n\n### Run with Docker\n\n```bash\n# Build image\ndocker build -t my-component .\n\n# Run container\ndocker run --rm \\\n  -v $(pwd)/data:/data \\\n  -e KBC_DATADIR=/data \\\n  my-component\n```\n\n## State Management\n\nFor incremental loads, use state files:\n\n```python\nfrom datetime import datetime\n\nclass Component(ComponentBase):\n    def run(self):\n        # Load previous state\n        state = self.get_state_file()\n        last_run = state.get('last_run', '2000-01-01')\n\n        # Process only new data\n        # ... processing logic ...\n\n        # Save new state\n        self.write_state_file({\n            'last_run': datetime.now().isoformat()\n        })\n```\n\n## Deployment\n\n### Using Developer Portal\n\n1. Register component via API:\n\n```python\nimport requests\n\nresponse = requests.post(\n    f\"https://{stack_url}/v2/storage/dev-branches/default/components\",\n    headers={\"X-StorageApi-Token\": token},\n    json={\n        \"id\": \"my-org.my-component\",\n        \"type\": \"transformation\",\n        \"name\": \"My Component\",\n        \"repository\": {\n            \"type\": \"github\",\n            \"url\": \"https://github.com/my-org/my-component\",\n            \"tag\": \"1.0.0\"\n        }\n    }\n)\n```\n\n2. Push to GitHub with proper tags\n3. Keboola builds Docker image automatically\n4. Component becomes available in your project\n\n### GitHub Repository Setup\n\n```yaml\n# .github/workflows/build.yml\nname: Build\n\non:\n  push:\n    tags:\n      - '*'\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - name: Build and push\n        run: |\n          docker build -t my-component:${GITHUB_REF#refs/tags/} .\n          # Keboola pulls from your repository\n```\n\n## Common Component Patterns\n\n### Error Handling\n\n```python\nfrom keboola.component.exceptions import UserException\n\ntry:\n    result = process_data(input_data)\nexcept ValueError as e:\n    # User-facing error (shown in Keboola UI)\n    raise UserException(f\"Invalid data format: {e}\")\nexcept Exception as e:\n    # System error (triggers alert)\n    raise\n```\n\n### Logging\n\n```python\nclass Component(ComponentBase):\n    def run(self):\n        self.logging.info(\"Starting processing\")\n        self.logging.debug(f\"Config: {self.configuration.parameters}\")\n        self.logging.warning(\"Found duplicate records\")\n        self.logging.error(\"Failed to process row\")\n```\n\n### Configuration Schema\n\nDefine schema in `component_config/component.json`:\n\n```json\n{\n  \"type\": \"object\",\n  \"required\": [\"multiplier\"],\n  \"properties\": {\n    \"multiplier\": {\n      \"type\": \"integer\",\n      \"title\": \"Multiplier\",\n      \"description\": \"Value to multiply by\",\n      \"minimum\": 1\n    }\n  }\n}\n```\n\n## Related Documentation\n\nFor comprehensive component development:\n- **Component Architecture**: `claude/component-developer/guides/component-builder/architecture.md`\n- **Testing Guide**: `claude/component-developer/guides/component-builder/running-and-testing.md`\n- **Developer Portal**: `claude/component-developer/guides/component-builder/developer-portal.md`\n- **Cookiecutter Template**: https://github.com/keboola/cookiecutter-python-component\n\n\n---\n\n## Metadata",
      "reasoning": "This new section fills the critical gap identified in TS-004 by providing comprehensive coverage of Custom Python Components. It includes all required elements: component structure, keboola.component library usage, Input/Output mapping, manifest files, Dockerfile examples, local testing approaches, and deployment instructions. The section maintains consistency with the existing SKILL.md style while cross-referencing the detailed component-developer documentation for users who need deeper guidance."
    },
    {
      "file": "claude/keboola-core/SKILL.md",
      "section": "Lines 9-12 (When to activate this skill section)",
      "current": "**When to activate this skill:**\n- User asks about Keboola Storage API\n- User needs help with Keboola Jobs API\n- User asks about regional stacks or Stack URLs\n- User encounters Keboola-related errors",
      "proposed": "**When to activate this skill:**\n- User asks about Keboola Storage API\n- User needs help with Keboola Jobs API\n- User asks about regional stacks or Stack URLs\n- User encounters Keboola-related errors\n- User wants to create Custom Python components/transformations\n- User asks about component deployment or Docker\n- User needs help with keboola.component library",
      "reasoning": "Updates the activation criteria to include Custom Python Components, ensuring the skill is properly triggered when users ask about component development, which was the core issue identified in TS-004."
    }
  ],
  "pr_title": "Add Custom Python Components Section to keboola-core SKILL.md",
  "pr_description": "## Problem\n\nTest Scenario TS-004 identified a critical gap in the `keboola-core/SKILL.md` documentation. While the file excellently covers Storage API usage and direct API calls, it completely lacks information about Custom Python Components - a key feature for users who need to create custom transformations.\n\n**Missing Coverage:**\n- Custom Python component structure\n- `keboola.component` library usage\n- Input/Output mapping configuration\n- Manifest file handling\n- Dockerfile creation\n- Local testing approaches\n- Component deployment process\n\n## Changes\n\n### 1. New Section: Custom Python Components\n\nAdded comprehensive section covering:\n- **Component Structure**: Directory layout and file organization\n- **Component Code**: Complete example using `keboola.component.base.ComponentBase`\n- **Input/Output Mapping**: Configuration format and table access patterns\n- **Manifest Files**: Automatic generation and structure\n- **Dockerfile**: Best practices for containerization\n- **Local Testing**: Setup instructions for both Python and Docker execution\n- **State Management**: Incremental load patterns\n- **Deployment**: Developer Portal integration and GitHub setup\n- **Common Patterns**: Error handling, logging, configuration schemas\n\n### 2. Updated Activation Criteria\n\nAdded triggers for:\n- Custom Python component creation\n- Component deployment questions\n- `keboola.component` library usage\n\n### 3. Cross-References\n\nLinked to existing component-developer documentation for users needing deeper guidance:\n- Architecture guide\n- Testing guide\n- Developer Portal guide\n- Official cookiecutter template\n\n## Validation\n\nThis change addresses all validation criteria from TS-004:\n- \u2705 Uses keboola.component library\n- \u2705 Shows Input/Output mapping config\n- \u2705 Explains manifest files\n- \u2705 Includes Dockerfile\n- \u2705 Shows local testing approach\n\n## Impact\n\n- Closes documentation gap for Custom Python Components\n- Enables Claude to provide complete answers for component development queries\n- Maintains consistency with existing keboola-core documentation style\n- Complements (rather than duplicates) existing component-developer documentation\n\n## Testing\n\nAfter this change, the query from TS-004 (\"I want to create a Custom Python script that reads from Storage, processes data, and writes back. How do I deploy it?\") should receive a complete answer including component structure, code examples, and deployment steps."
}