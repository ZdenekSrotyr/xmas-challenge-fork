{
  "analysis": "SKILL.md lacks explanation of the Stack URL concept, which is fundamental to Keboola API usage. The documentation hardcodes 'connection.keboola.com' throughout without explaining that this is region-specific. Users in EU or other regions cannot determine their correct API base URL. This needs: (1) A new core concept section explaining Stack URL vs Project ID, (2) Regional stack documentation, (3) How to find your stack URL, (4) Updates to all code examples to use a configurable base URL pattern.",
  "changes": [
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "After 'Core Concepts: The Keboola Hierarchy' section, before 'Storage Structure'",
      "current": null,
      "proposed": "### Stack URL: Your Regional API Endpoint\n\n**What is a Stack URL?**\n\nKeboola operates multiple regional deployments (\"stacks\") across the world. Each stack has its own base URL that serves as the foundation for all API calls. The Stack URL is **separate from and independent of** your Project ID.\n\n**Key Distinction:**\n- **Stack URL**: The regional API endpoint (e.g., `connection.keboola.com`)\n- **Project ID**: Your specific project identifier (e.g., `12345`)\n\nYou need **both** to make API calls: `https://{STACK_URL}/v2/storage/...`\n\n#### Available Regional Stacks\n\n| Region | Stack URL | Location |\n|--------|-----------|----------|\n| US | `connection.keboola.com` | AWS US East (Virginia) |\n| EU | `connection.eu-central-1.keboola.com` | AWS EU Central (Frankfurt) |\n| Azure North Europe | `connection.north-europe.azure.keboola.com` | Azure North Europe (Ireland) |\n\n#### How to Find Your Stack URL\n\n**Method 1: Check Your Login URL**\n\nYour Stack URL is the domain you use to log into Keboola:\n\n```\nhttps://connection.keboola.com/admin/projects/12345/...\n         ^^^^^^^^^^^^^^^^^^^^^^^\n         This is your Stack URL\n```\n\n**Method 2: Use MCP Server**\n\n```python\n# Get project info including stack details\nproject_info = mcp__keboola__get_project_info()\n\n# Returns:\n# {\n#   \"id\": 12345,\n#   \"url\": \"https://connection.keboola.com\",\n#   \"stack\": \"connection.keboola.com\",\n#   \"backend\": \"snowflake\",\n#   ...\n# }\n\nstack_url = project_info[\"stack\"]\n```\n\n**Method 3: Ask Your Keboola Administrator**\n\nIf you're unsure, contact your Keboola administrator or check your onboarding documentation.\n\n#### Using Stack URL in API Calls\n\n**\u274c WRONG: Hardcoded regional URL**\n```python\nbase_url = \"https://connection.keboola.com\"  # Only works for US region!\n```\n\n**\u2705 CORRECT: Configurable Stack URL**\n```python\n# Store as configuration\nSTACK_URL = \"connection.eu-central-1.keboola.com\"  # EU region\nPROJECT_ID = 12345\nSTORAGE_TOKEN = \"your-token\"\n\nbase_url = f\"https://{STACK_URL}\"\n\n# Make API calls\nresponse = requests.get(\n    f\"{base_url}/v2/storage/tables\",\n    headers={\"X-StorageApi-Token\": STORAGE_TOKEN}\n)\n```\n\n**Best Practice Pattern:**\n```python\nimport os\n\n# Load from environment variables\nSTACK_URL = os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")\nPROJECT_ID = os.environ[\"KEBOOLA_PROJECT_ID\"]\nSTORAGE_TOKEN = os.environ[\"KEBOOLA_TOKEN\"]\n\nbase_url = f\"https://{STACK_URL}\"\n```\n\n#### Stack URL in MCP Server\n\nThe MCP server automatically determines your Stack URL during OAuth authentication. You don't need to configure it manually when using MCP functions.\n\n#### Common Mistakes\n\n**Mistake 1: Using US Stack for EU Project**\n```python\n# EU project trying to use US stack\nbase_url = \"https://connection.keboola.com\"  # Wrong stack!\nresponse = requests.get(\n    f\"{base_url}/v2/storage/tables\",\n    headers={\"X-StorageApi-Token\": eu_project_token}\n)\n# Returns: 401 Unauthorized or 404 Not Found\n```\n\n**Mistake 2: Confusing Stack URL with Project ID**\n```python\n# Don't use Project ID as part of the base URL\nbase_url = f\"https://connection.keboola.com/projects/{PROJECT_ID}\"  # Wrong!\n\n# Project ID is used in specific endpoints, not the base URL\nbase_url = f\"https://{STACK_URL}\"  # Correct base\nendpoint = f\"{base_url}/v2/storage/projects/{PROJECT_ID}/...\"  # When needed\n```\n\n**Mistake 3: Mixing Stack URLs**\n```python\n# Don't mix different regional endpoints in the same script\nread_url = \"https://connection.keboola.com\"\nwrite_url = \"https://connection.eu-central-1.keboola.com\"\n# These are completely separate Keboola instances!\n```\n\n<details>\n<summary>Deep Dive: Stack Architecture and Token Scope</summary>\n\n**Stack Isolation:**\n\nEach Keboola stack is a completely independent deployment:\n- Separate databases\n- Separate user accounts\n- Separate projects\n- Separate API tokens\n\nA token from the US stack will **never** work with the EU stack, even if you have projects in both regions.\n\n**Token-Stack Binding:**\n\nWhen you create a Storage API token, it's bound to:\n1. A specific project\n2. On a specific stack\n3. With specific permissions\n\nExample:\n```\nToken: abc123...\nProject: 12345\nStack: connection.eu-central-1.keboola.com\nScope: storage:read, storage:write\n```\n\nThis token:\n- \u2705 Works with: `https://connection.eu-central-1.keboola.com`\n- \u274c Fails with: `https://connection.keboola.com` (different stack)\n- \u274c Fails with: Project 67890 (different project)\n\n**Multi-Region Organizations:**\n\nSome organizations have projects across multiple stacks. Each project requires:\n- Its own Stack URL\n- Its own Project ID\n- Its own API token\n\nManaging multi-region setup:\n```python\nPROJECTS = [\n    {\n        \"name\": \"US Production\",\n        \"stack\": \"connection.keboola.com\",\n        \"project_id\": 12345,\n        \"token\": os.environ[\"KEBOOLA_TOKEN_US\"]\n    },\n    {\n        \"name\": \"EU Production\",\n        \"stack\": \"connection.eu-central-1.keboola.com\",\n        \"project_id\": 67890,\n        \"token\": os.environ[\"KEBOOLA_TOKEN_EU\"]\n    }\n]\n\nfor project in PROJECTS:\n    base_url = f\"https://{project['stack']}\"\n    # Make API calls with project-specific configuration\n```\n\n</details>",
      "reasoning": "Adds comprehensive Stack URL documentation as a core concept, explaining the distinction from Project ID, listing regional stacks, showing how to find your stack, and providing correct usage patterns."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Storage API Patterns - Reading Tables - Using Storage API Directly example",
      "current": "```python\nimport requests\n\n# Configuration\nproject_id = 12345\nstorage_token = \"your-storage-token\"\nbase_url = f\"https://connection.keboola.com\"\n\nheaders = {\n    \"X-StorageApi-Token\": storage_token,\n    \"Content-Type\": \"application/json\"\n}",
      "proposed": "```python\nimport requests\nimport os\n\n# Configuration\n# IMPORTANT: Use YOUR stack URL, not hardcoded connection.keboola.com\nstack_url = os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")\nproject_id = 12345\nstorage_token = os.environ[\"KEBOOLA_TOKEN\"]\nbase_url = f\"https://{stack_url}\"\n\nheaders = {\n    \"X-StorageApi-Token\": storage_token,\n    \"Content-Type\": \"application/json\"\n}",
      "reasoning": "Updates the first API example to use configurable Stack URL instead of hardcoded US region URL, setting the pattern for all subsequent examples."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Jobs API Patterns - Running Components example",
      "current": "```python\n# Run a specific component configuration\nresponse = requests.post(\n    f\"{base_url}/v2/storage/components/keboola.ex-db-mysql/configs/123456/run\",",
      "proposed": "```python\n# Run a specific component configuration\n# Note: base_url should be https://{your-stack-url} as shown in Storage API section\nresponse = requests.post(\n    f\"{base_url}/v2/storage/components/keboola.ex-db-mysql/configs/123456/run\",",
      "reasoning": "Adds clarifying comment reminding users that base_url must use their specific stack URL."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Working Code Examples - Example 1: Complete ETL Script",
      "current": "# Configuration\nKEBOOLA_PROJECT_ID = 12345\nKEBOOLA_TOKEN = os.environ[\"KEBOOLA_TOKEN\"]\nKEBOOLA_URL = \"https://connection.keboola.com\"",
      "proposed": "# Configuration\n# IMPORTANT: Set KEBOOLA_STACK_URL to your region's stack\n# US: connection.keboola.com\n# EU: connection.eu-central-1.keboola.com\n# Azure: connection.north-europe.azure.keboola.com\nKEBOOLA_STACK_URL = os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")\nKEBOOLA_PROJECT_ID = 12345\nKEBOOLA_TOKEN = os.environ[\"KEBOOLA_TOKEN\"]\nKEBOOLA_URL = f\"https://{KEBOOLA_STACK_URL}\"",
      "reasoning": "Updates complete example to use configurable stack URL with inline documentation of available regions."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Working Code Examples - Example 2: Orchestration with Error Handling",
      "current": "KEBOOLA_URL = \"https://connection.keboola.com\"\nKEBOOLA_TOKEN = os.environ[\"KEBOOLA_TOKEN\"]\nORCHESTRATION_ID = 123456",
      "proposed": "# Use your stack URL - find it from your Keboola login URL domain\nKEBOOLA_STACK_URL = os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")\nKEBOOLA_URL = f\"https://{KEBOOLA_STACK_URL}\"\nKEBOOLA_TOKEN = os.environ[\"KEBOOLA_TOKEN\"]\nORCHESTRATION_ID = 123456",
      "reasoning": "Makes orchestration example consistent with stack URL pattern and adds comment about finding stack URL."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Common Pitfalls and Solutions - After Pitfall 7",
      "current": null,
      "proposed": "### Pitfall 8: Using Wrong Stack URL\n\n**Problem**: API calls fail with 401/404 errors despite valid token\n\n**Solution**:\n\n```python\n# \u274c WRONG: EU project using US stack URL\nstack_url = \"connection.keboola.com\"  # US stack\neu_token = \"your-eu-project-token\"\n\nresponse = requests.get(\n    f\"https://{stack_url}/v2/storage/tables\",\n    headers={\"X-StorageApi-Token\": eu_token}\n)\n# Returns: 401 Unauthorized - token not found\n\n# \u2705 CORRECT: Match stack URL to your project's region\nstack_url = \"connection.eu-central-1.keboola.com\"  # EU stack\neu_token = \"your-eu-project-token\"\n\nresponse = requests.get(\n    f\"https://{stack_url}/v2/storage/tables\",\n    headers={\"X-StorageApi-Token\": eu_token}\n)\n# Success!\n```\n\n**How to diagnose**:\n\n1. Check your Keboola login URL:\n   - If you log in at `connection.eu-central-1.keboola.com` \u2192 Use EU stack\n   - If you log in at `connection.keboola.com` \u2192 Use US stack\n\n2. Use MCP to verify:\n```python\nproject_info = mcp__keboola__get_project_info()\nprint(f\"Your stack: {project_info['stack']}\")\n```\n\n3. Look for these error patterns:\n   - `401 Unauthorized` + valid token = wrong stack\n   - `404 Not Found` + existing table = wrong stack\n   - Connection timeout = wrong stack (network routing failure)\n\n**Prevention**:\n\nAlways use environment variables for stack configuration:\n\n```python\nimport os\n\n# Required environment variables:\n# KEBOOLA_STACK_URL - Your region's stack (e.g., connection.eu-central-1.keboola.com)\n# KEBOOLA_TOKEN - Your project's API token\n\nSTACK_URL = os.environ[\"KEBOOLA_STACK_URL\"]  # Fail fast if not set\nbase_url = f\"https://{STACK_URL}\"\n\n# Now all API calls use the correct region\n```",
      "reasoning": "Adds new pitfall specifically addressing the Stack URL confusion, with diagnosis steps and prevention patterns."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "Summary: Key Takeaways - Quick Reference Card",
      "current": "```\nAuthentication:\n  Storage API: X-StorageApi-Token header\n  MCP Server: OAuth (prompted on first use)\n\nProject ID:\n  From URL: connection.keboola.com/admin/projects/[ID]\n  From MCP: mcp__keboola__get_project_info()",
      "proposed": "```\nStack URL (Regional Endpoint):\n  US: connection.keboola.com\n  EU: connection.eu-central-1.keboola.com\n  Find yours: Check your login URL domain\n  From MCP: mcp__keboola__get_project_info()[\"stack\"]\n\nAuthentication:\n  Storage API: X-StorageApi-Token header\n  MCP Server: OAuth (prompted on first use)\n  Token Scope: Bound to specific project AND stack\n\nProject ID:\n  From URL: https://{stack-url}/admin/projects/[ID]\n  From MCP: mcp__keboola__get_project_info()[\"id\"]",
      "reasoning": "Adds Stack URL as the first item in the quick reference card and clarifies that tokens are bound to both project and stack."
    },
    {
      "file": "plugins/keboola-core/skills/keboola-knowledge/SKILL.md",
      "section": "When to Use This Skill - activation triggers list",
      "current": "- Keboola platform concepts (workspace, branch, configuration, etc.)\n- Storage API operations (reading/writing tables, buckets, metadata)\n- Jobs API operations (running transformations, components, orchestrations)",
      "proposed": "- Keboola platform concepts (workspace, branch, configuration, stack URL, etc.)\n- Storage API operations (reading/writing tables, buckets, metadata)\n- Jobs API operations (running transformations, components, orchestrations)\n- Regional deployment and stack URL questions\n- API endpoint and authentication troubleshooting",
      "reasoning": "Adds Stack URL-related scenarios to the skill activation triggers to ensure it activates when users ask about regions or API endpoints."
    }
  ],
  "pr_title": "Add Stack URL concept and regional deployment guidance to SKILL.md",
  "pr_description": "## Summary\n\nAdds comprehensive documentation for Stack URL concept and regional deployment, addressing confusion between Stack URL and Project ID.\n\n## Changes\n\n### 1. New Core Concept Section: Stack URL\n\n- Explains Stack URL as distinct from Project ID\n- Lists all available regional stacks (US, EU, Azure)\n- Shows how to find your stack URL (login URL, MCP, admin)\n- Provides correct API usage patterns with configurable stack URLs\n- Includes common mistakes and troubleshooting\n- Deep dive on stack architecture and token-stack binding\n\n### 2. Updated Code Examples\n\n- **Storage API examples**: Changed from hardcoded `connection.keboola.com` to configurable `KEBOOLA_STACK_URL` environment variable\n- **Jobs API examples**: Added clarifying comments about base_url requirements\n- **Complete ETL example**: Updated with stack URL configuration and inline documentation\n- **Orchestration example**: Updated to use configurable stack URL\n- All examples now follow best practice: `stack_url = os.environ.get(\"KEBOOLA_STACK_URL\", \"connection.keboola.com\")`\n\n### 3. New Common Pitfall\n\n- Added \"Pitfall 8: Using Wrong Stack URL\"\n- Explains error symptoms (401/404 despite valid token)\n- Shows diagnosis steps (check login URL, use MCP, recognize error patterns)\n- Provides prevention pattern using environment variables\n\n### 4. Updated Quick Reference Card\n\n- Added Stack URL section as first item\n- Lists all regional stack URLs\n- Shows how to find your stack\n- Clarifies that tokens are bound to both project AND stack\n\n### 5. Updated Skill Activation Triggers\n\n- Added \"Regional deployment and stack URL questions\"\n- Added \"API endpoint and authentication troubleshooting\"\n\n## Impact\n\n### Fixes\n\n- \u2705 Users can now determine which base URL to use for API calls\n- \u2705 EU and other regional users won't incorrectly use US stack URLs\n- \u2705 Clear distinction between UI URLs and API endpoints\n- \u2705 Troubleshooting guidance for \"wrong region\" authentication errors\n\n### Backward Compatibility\n\n- All existing examples continue to work with default US stack\n- Added environment variable pattern allows easy regional configuration\n- No breaking changes to existing code that uses US stack\n\n## Testing Recommendations\n\nAfter merge, verify:\n\n1. Claude Code can explain Stack URL vs Project ID distinction\n2. Claude Code recommends correct stack URL for EU users\n3. Claude Code updates hardcoded examples with configurable patterns\n4. Re-run TS-006 test scenario to verify issue resolution\n\n## Related Issues\n\n- Closes: [Auto-Report] keboola-core: SKILL.md missing Stack URL concept explanation\n- Test Report: TEST_REPORT_TS-006.md"
}