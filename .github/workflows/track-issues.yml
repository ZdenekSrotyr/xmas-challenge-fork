name: Track Issues in Graph

on:
  issues:
    types: [opened, closed, reopened]

# Automatically track issues in the knowledge graph

jobs:
  track-issue:
    runs-on: ubuntu-latest

    permissions:
      issues: read
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get issue data
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // Save to file for Python script
            const fs = require('fs');
            fs.writeFileSync(
              'issue-data.json',
              JSON.stringify(issue.data, null, 2)
            );

      - name: Track issue in graph
        run: |
          cd automation/graph

          if [ "${{ github.event.action }}" == "opened" ]; then
            python event_handler.py issue created ${{ github.event.issue.number }} \
              --data ../../issue-data.json

          elif [ "${{ github.event.action }}" == "closed" ]; then
            python event_handler.py issue closed ${{ github.event.issue.number }}

          elif [ "${{ github.event.action }}" == "reopened" ]; then
            # Reopen by updating status
            python -c "
          from knowledge_graph import KnowledgeGraph
          with KnowledgeGraph() as graph:
              graph.update_node('Issue:${{ github.event.issue.number }}', status='open')
              print('âœ“ Issue #${{ github.event.issue.number }} reopened in graph')
          "
          fi

      - name: Commit graph changes
        id: check-changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if graph DB changed
          if [ -f automation/graph/data/graph.db ]; then
            git add automation/graph/data/graph.db

            if git diff --staged --quiet; then
              echo "â„¹ï¸ No graph changes to commit"
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              git commit -m "chore(graph): Track Issue #${{ github.event.issue.number }}

          Action: ${{ github.event.action }}

          [skip ci]"
              git push
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger UI rebuild
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "ðŸ”„ Triggering UI deployment..."
          gh workflow run deploy-ui.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Knowledge Graph Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f automation/graph/data/graph.db ]; then
            cd automation/graph
            python knowledge_graph.py --stats >> $GITHUB_STEP_SUMMARY
          fi
