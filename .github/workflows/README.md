# Self-Healing GitHub Actions Workflows

This directory contains three automated workflows that create a self-healing knowledge base for the Keboola AI assistant.

## Overview

```
Issue Created with "auto-report" label
         ↓
   auto-triage.yml
   (Analyzes with Claude API)
         ↓
   Categorizes + Confidence Score
         ↓
   [High Confidence ≥80%] → propose-fix.yml
         ↓
   Creates PR with Fix
         ↓
   Human Review → Merge
         ↓
   Knowledge Updated
```

## Workflows

### 1. auto-triage.yml

**Purpose:** Automatically triages issues reported with the "auto-report" label.

**Triggers:**
- When an issue is created or labeled with "auto-report"

**What it does:**
1. Analyzes the issue using Claude API
2. Categorizes into: `api-error`, `outdated-docs`, `pitfall`, or `other`
3. Assigns confidence score (0-100%)
4. Adds appropriate labels to the issue
5. Posts analysis comment on the issue
6. If confidence ≥ 80%, triggers the `propose-fix` workflow automatically

**Required Secrets:**
- `ANTHROPIC_API_KEY`: Your Anthropic API key for Claude

**Output Labels:**
- `category:<category>`: The assigned category
- `priority:<level>`: high/medium/low priority
- `confidence:<score>`: The confidence score
- Additional context-specific labels

**Example Issue:**
```markdown
Title: API authentication fails with new token format
Labels: auto-report

Description:
When using the new token format (starts with KBC_), authentication fails...
```

**Result:**
- Category: `api-error`
- Confidence: 95%
- Priority: `high`
- Action: Automatically triggers propose-fix workflow

---

### 2. validate-examples.yml

**Purpose:** Continuously validates code examples and documentation links in SKILL.md files.

**Triggers:**
- **Schedule:** Daily at 2 AM UTC
- **Pull Requests:** When SKILL.md files or other markdown files are modified
- **Manual:** Via workflow_dispatch

**What it does:**
1. Finds all SKILL.md files in the repository
2. Extracts Python code blocks and validates syntax
3. Checks all Keboola documentation links for broken URLs
4. Creates a validation report
5. On PRs: Comments with validation results
6. On schedule: Creates an issue if validation fails

**Validation Checks:**
- ✅ Python syntax validation (skips templates with `...`, `TODO`, `PLACEHOLDER`)
- ✅ Link checking for Keboola domains (developers.keboola.com, help.keboola.com, etc.)
- ✅ Rate-limited requests to avoid overwhelming servers
- ✅ Retry logic for transient failures

**No Secrets Required:** Uses standard GitHub token

**Example Output:**
```markdown
# Validation Report

## Python Code Examples
- Total examples: 42
- Valid examples: 41
- Invalid examples: 1

## Documentation Links
- Total links checked: 18
- Valid links: 16
- Broken links: 2

## Python Syntax Errors
- plugins/component-developer/SKILL.md (block 5): SyntaxError: invalid syntax at line 3

## Broken Links
- plugins/dataapp-developer/SKILL.md: https://developers.keboola.com/old-endpoint - 404 Not Found
```

**Artifacts:**
- `validation_report.md`: Full validation report
- `validation_errors.txt`: List of syntax errors
- `broken_links.txt`: List of broken links
- Retained for 30 days

---

### 3. propose-fix.yml

**Purpose:** Generates and submits automated fixes for triaged issues.

**Triggers:**
- **Automatic:** Triggered by auto-triage.yml when confidence ≥ 80%
- **Manual:** Via workflow_dispatch with issue_number and category

**What it does:**
1. Fetches the issue details from GitHub
2. Identifies relevant files to update based on category
3. Uses Claude API to generate specific fix proposals
4. Applies the proposed changes to files
5. Creates a new git branch
6. Commits changes with proper attribution
7. Opens a pull request for human review
8. Comments on the original issue with PR link

**Required Secrets:**
- `ANTHROPIC_API_KEY`: Your Anthropic API key for Claude

**Manual Trigger Example:**
```bash
# Via GitHub CLI
gh workflow run propose-fix.yml \
  -f issue_number=42 \
  -f category=api-error
```

**Category-Based File Selection:**
- `api-error`: Files mentioning API, client, authentication, endpoints
- `outdated-docs`: All SKILL.md files
- `pitfall`: Files with pitfall or common mistakes sections
- `other`: Files explicitly mentioned in the issue

**PR Content:**
- Title and description generated by Claude
- Detailed analysis and reasoning for each change
- Review checklist for human reviewers
- Automatic labels: `automated-fix`, `needs-review`, `category:<type>`

**Example PR:**
```markdown
## Automated Fix Proposal

**Fixes:** #42
**Category:** `api-error`

### Analysis
The issue reports authentication failures with new token format. The current
documentation only shows the old format. This update adds examples for both
token formats and clarifies when each should be used.

### Changes Made

#### plugins/component-developer/guides/authentication.md
**Section:** Authentication
**Reasoning:** Add support for new KBC_ token format
**Proposed Change:**
[Code block with updated authentication example]

---

⚠️ **This PR was automatically generated by AI.**

**Required Actions:**
- [ ] Review all changes for accuracy
- [ ] Verify code examples work correctly
- [ ] Check that links are valid
- [ ] Ensure documentation style is consistent
- [ ] Test any code changes
```

**Artifacts:**
- `fix_proposal.json`: Complete fix proposal from Claude
- Retained for 30 days

---

## Setup Instructions

### 1. Add Required Secrets

Go to your repository Settings → Secrets and variables → Actions, and add:

- `ANTHROPIC_API_KEY`: Your Anthropic API key
  - Get it from: https://console.anthropic.com/settings/keys
  - Permissions needed: API access for Claude Sonnet 4.5

### 2. Enable GitHub Actions

Ensure GitHub Actions are enabled for your repository:
- Settings → Actions → General → Allow all actions and reusable workflows

### 3. Configure Permissions

The workflows need these permissions (configured in each workflow file):
- `issues: write` - To add labels and comments
- `contents: write` - To create branches and commits
- `pull-requests: write` - To create pull requests

### 4. Set Up Branch Protection (Recommended)

Protect your main branch to require PR reviews:
- Settings → Branches → Add rule for `main`
- Enable "Require a pull request before merging"
- Enable "Require approvals" (at least 1)

This ensures all automated fixes are reviewed before merging.

### 5. Test the Workflows

#### Test auto-triage:
1. Create an issue with the "auto-report" label
2. Wait for the workflow to run (should be automatic)
3. Check the issue for analysis comment and labels

#### Test validate-examples:
1. Go to Actions → Validate Examples → Run workflow
2. Check the run results for validation report
3. Review any artifacts generated

#### Test propose-fix:
1. Create a test issue with "auto-report" label
2. Wait for auto-triage to run with high confidence
3. Check for automatic PR creation
4. Or manually trigger: Actions → Propose Fix → Run workflow

---

## Best Practices

### For Auto-Reported Issues

When creating auto-report issues, include:
- Clear description of the problem
- Error messages or unexpected behavior
- Steps to reproduce
- Expected vs actual behavior
- File paths or documentation sections affected

### For Reviewing Automated PRs

1. **Never merge blindly** - Always review AI-generated changes
2. **Test code examples** - Run any code snippets to verify they work
3. **Check links** - Verify documentation links are correct
4. **Validate context** - Ensure changes make sense in context
5. **Improve if needed** - Edit the PR branch if changes need refinement

### For Maintaining Workflows

1. **Monitor workflow runs** - Check Actions tab regularly for failures
2. **Update API usage** - Keep Anthropic SDK up to date
3. **Tune confidence threshold** - Adjust the 80% threshold based on accuracy
4. **Review artifacts** - Check validation reports and fix proposals
5. **Update categories** - Add new categories as patterns emerge

---

## Troubleshooting

### Workflow not triggering

**Problem:** auto-triage doesn't run when issue is created

**Solutions:**
1. Ensure the issue has the "auto-report" label
2. Check Actions are enabled in repository settings
3. Verify workflow file syntax with `yamllint`
4. Check workflow logs in Actions tab for errors

### API rate limits

**Problem:** Claude API returns rate limit errors

**Solutions:**
1. The workflows use modern 2025 rate limits (higher than 2024)
2. Add delays between API calls if needed
3. Implement exponential backoff in error handling
4. Consider using caching for similar issues

### Fix proposals are inaccurate

**Problem:** propose-fix creates incorrect changes

**Solutions:**
1. Review the prompt in propose-fix.yml
2. Adjust category-based file selection logic
3. Lower confidence threshold to reduce auto-triggering
4. Add more context to the Claude prompt
5. Include example fixes in the prompt

### Validation false positives

**Problem:** validate-examples reports issues that aren't real problems

**Solutions:**
1. Update the validation script to handle edge cases
2. Add skip patterns for intentional templates
3. Adjust link checking logic for redirects
4. Add retry logic for intermittent network issues

---

## Architecture Decisions

### Why Claude Sonnet 4.5?

- **Latest model** (2025-09-29): Best reasoning and analysis capabilities
- **High token limit**: Can handle long documentation files
- **Structured output**: Reliable JSON generation for workflow automation
- **Context window**: Can analyze multiple files simultaneously

### Why separate triage and fix workflows?

1. **Fail gracefully**: Triage can succeed even if fix generation fails
2. **Manual override**: Humans can review triage before fix attempt
3. **Cost efficiency**: Only generate fixes for high-confidence issues
4. **Debugging**: Easier to debug issues in smaller workflows

### Why 80% confidence threshold?

- Balances automation with safety
- Based on testing, 80%+ shows high accuracy
- Adjustable in auto-triage.yml if needed
- Lower values create more PRs to review

### Why daily validation?

- Documentation can break due to external changes (link rot)
- Nightly runs avoid disrupting development
- PR validation catches issues before merge
- 2 AM UTC is low-traffic time for most timezones

---

## Future Enhancements

Potential improvements to consider:

1. **Machine Learning Feedback Loop**
   - Track which auto-fixes get merged vs rejected
   - Train on historical data to improve accuracy
   - Adjust confidence scoring based on outcomes

2. **Multi-File Fixes**
   - Coordinate changes across multiple related files
   - Update cross-references automatically
   - Maintain consistency across documentation

3. **Regression Testing**
   - Run automated tests on proposed changes
   - Validate examples in sandbox environment
   - Check rendering of markdown changes

4. **Smart Notifications**
   - Slack/Discord integration for critical issues
   - Summary reports of weekly triage activity
   - Alerts for validation failures

5. **Learning from Resolutions**
   - Analyze merged PRs to improve future proposals
   - Build database of common fix patterns
   - Auto-suggest similar fixes for related issues

---

## Contributing

To improve these workflows:

1. Test changes in a fork first
2. Use small, focused commits
3. Update this README with any workflow changes
4. Document new configuration options
5. Add error handling for edge cases

---

## License

These workflows are part of the Keboola AI knowledge base project.
See the main repository LICENSE file for details.
